<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeixinMPTools Web v1.3 - å¾®ä¿¡å…¬ä¼—å·æ’ç‰ˆå·¥å…·</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f3f4f6;
            --sidebar-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --glass: blur(12px);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* é»‘æš—æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3b82f6;
                --bg-color: #111827;
                --sidebar-bg: #1f2937;
                --card-bg: rgba(31, 41, 55, 0.8);
                --text-main: #f9fafb;
                --text-secondary: #9ca3af;
                --border: #374151;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: var(--transition);
        }

        /* ä¾§è¾¹æ  */
        aside {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 10;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background-color: var(--bg-color);
            color: var(--primary);
        }

        .nav-item.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* ä¸»å†…å®¹åŒº */
        main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }

        /* åŠŸèƒ½å¡ç‰‡å®¹å™¨ */
        .tool-container {
            display: none;
            max-width: 1000px;
            margin: 0 auto;
            animation: fadeIn 0.4s ease-out;
        }

        .tool-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .card h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        /* é€šç”¨æ§ä»¶æ ·å¼ */
        .control-group { margin-bottom: 1.5rem; }
        .control-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-color);
            color: var(--text-main);
            outline: none;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-secondary { background: var(--bg-color); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:hover { background: #e5e7eb; }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1rem;
            position: relative;
        }
        
        .upload-area:hover { border-color: var(--primary); background: rgba(37, 99, 235, 0.05); }
        .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* é¢„è§ˆåŒºåŸŸ */
        .preview-area {
            background: var(--bg-color);
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        canvas, img { max-width: 100%; max-height: 500px; border-radius: 4px; box-shadow: var(--shadow); }

        /* æ‹¼æ¥å·¥å…·ç‰¹å®šçš„ Grid */
        .stitch-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--sidebar-bg);
            border-top: 1px solid var(--border);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            z-index: 20;
        }

        /* æç¤ºæ¡† Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--text-main);
            color: var(--bg-color);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }
        .toast.show { transform: translateX(0); }

        /* èŒƒå›´æ»‘å— */
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

    </style>
</head>
<body>

    <aside>
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            WeixinMP
        </div>
        <nav>
            <div class="nav-item active" onclick="switchTab('stitch')">ğŸ“¸ å›¾ç‰‡æ‹¼æ¥</div>
            <div class="nav-item" onclick="switchTab('extract')">ğŸ”— å°é¢æå–</div>
            <div class="nav-item" onclick="switchTab('compress')">ğŸ“‰ å›¾ç‰‡å‹ç¼©</div>
            <div class="nav-item" onclick="switchTab('watermark')">ğŸ’§ å›¾ç‰‡æ°´å°</div>
            <div class="nav-item" onclick="switchTab('crop')">âœ‚ï¸ å›¾ç‰‡è£å‰ª</div>
            <div class="nav-item" onclick="switchTab('convert')">ğŸ”„ æ ¼å¼è½¬æ¢</div>
            <div class="nav-item" onclick="switchTab('article')">ğŸ“ æ–‡ç« è¾…åŠ©</div>
            <div class="nav-item" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</div>
        </nav>
    </aside>

    <main>
        <div id="stitch" class="tool-container active">
            <div class="card">
                <h2>å›¾ç‰‡æ‹¼æ¥å·¥å…· (ç”µå½±ç¥¨/é•¿å›¾)</h2>
                <div class="stitch-grid">
                    <div>
                        <div class="control-group">
                            <label>ä¸Šæ–¹å›¾ (2.35:1)</label>
                            <div class="upload-area" id="top-area">
                                <span>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡</span>
                                <input type="file" id="stitch-top-input" accept="image/*">
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="control-group">
                            <label>ä¸‹æ–¹å›¾ (1:1)</label>
                            <div class="upload-area" id="bottom-area">
                                <span>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡</span>
                                <input type="file" id="stitch-bottom-input" accept="image/*">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>æ‹¼æ¥è®¾ç½®</label>
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <label><input type="radio" name="stitch-width" value="max" checked> è¾ƒå®½åŸºå‡†</label>
                        <label><input type="radio" name="stitch-width" value="min"> è¾ƒçª„åŸºå‡†</label>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span>é—´è·:</span>
                            <input type="range" id="stitch-spacing" min="0" max="100" value="0" style="width: 100px;">
                            <span id="spacing-val">0px</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span>èƒŒæ™¯:</span>
                            <select id="stitch-bg">
                                <option value="white">ç™½è‰²</option>
                                <option value="transparent">é€æ˜</option>
                                <option value="black">é»‘è‰²</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <button class="btn" onclick="processStitch()">æ‰§è¡Œæ‹¼æ¥</button>
                    <button class="btn btn-secondary" onclick="downloadCanvas('stitch-canvas', 'stitched.png')">ä¿å­˜ç»“æœ</button>
                </div>

                <div class="preview-area">
                    <canvas id="stitch-canvas"></canvas>
                </div>
            </div>
        </div>

        <div id="extract" class="tool-container">
            <div class="card">
                <h2>æå–å¾®ä¿¡æ¨é€å°é¢å›¾</h2>
                <div class="control-group">
                    <label>å…¬ä¼—å·æ–‡ç« é“¾æ¥</label>
                    <input type="text" id="extract-url" placeholder="è¯·ç²˜è´´ https://mp.weixin.qq.com/... å¼€å¤´çš„é“¾æ¥">
                </div>
                <div class="control-group">
                    <button class="btn" onclick="mockExtract()">æå–å°é¢</button>
                </div>
                <div class="preview-area" style="flex-direction: column; gap: 10px;">
                    <div id="extract-loading" style="display: none;">æ­£åœ¨è§£æä¸­ (Webç‰ˆéœ€CORSä»£ç†)...</div>
                    <img id="extract-img" style="display: none; max-width: 300px;">
                    <p id="extract-msg" style="color: var(--text-secondary); padding: 10px; text-align: center;">æç¤ºï¼šç”±äºæµè§ˆå™¨åŒæºç­–ç•¥(CORS)é™åˆ¶ï¼Œçº¯å‰ç«¯ç½‘é¡µæ— æ³•ç›´æ¥è¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨ã€‚æ­¤åŠŸèƒ½åœ¨æ¡Œé¢ç‰ˆè½¯ä»¶ä¸­å¯ç”¨ã€‚</p>
                </div>
            </div>
        </div>

        <div id="compress" class="tool-container">
            <div class="card">
                <h2>å›¾ç‰‡å‹ç¼©å·¥å…·</h2>
                <div class="upload-area">
                    <span>é€‰æ‹©ä¸€å¼ æˆ–å¤šå¼ å›¾ç‰‡è¿›è¡Œå‹ç¼©</span>
                    <input type="file" id="compress-input" accept="image/*" multiple>
                </div>
                <div class="control-group">
                    <label>å‹ç¼©è´¨é‡: <span id="quality-val">80</span>%</label>
                    <input type="range" id="compress-quality" min="10" max="100" value="80" oninput="document.getElementById('quality-val').innerText = this.value">
                </div>
                <div class="control-group">
                    <button class="btn" onclick="processCompress()">å¼€å§‹å‹ç¼©</button>
                </div>
                <div id="compress-results" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    </div>
            </div>
        </div>

        <div id="watermark" class="tool-container">
            <div class="card">
                <h2>å›¾ç‰‡æ°´å°å·¥å…·</h2>
                <div class="stitch-grid">
                    <div>
                        <div class="upload-area">
                            <span>é€‰æ‹©åº•å›¾</span>
                            <input type="file" id="wm-base-input" accept="image/*">
                        </div>
                    </div>
                    <div>
                         <div class="control-group">
                            <label>æ°´å°ç±»å‹</label>
                            <select id="wm-type" onchange="toggleWmInput()">
                                <option value="text">æ–‡å­—æ°´å°</option>
                                <option value="image">å›¾ç‰‡æ°´å°</option>
                            </select>
                        </div>
                        <div id="wm-text-controls" class="control-group">
                            <label>æ–‡å­—å†…å®¹</label>
                            <input type="text" id="wm-text" value="@æˆ‘çš„å…¬ä¼—å·">
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="color" id="wm-color" value="#ffffff">
                                <input type="number" id="wm-size" value="24" style="width: 80px;" placeholder="å­—å·">
                            </div>
                        </div>
                        <div id="wm-image-controls" class="control-group" style="display: none;">
                            <label>ä¸Šä¼ æ°´å°å›¾</label>
                            <input type="file" id="wm-watermark-input" accept="image/*">
                        </div>
                        <div class="control-group">
                            <label>ä½ç½® & é€æ˜åº¦</label>
                            <select id="wm-position">
                                <option value="bottom-right">å³ä¸‹è§’</option>
                                <option value="center">å±…ä¸­</option>
                                <option value="top-left">å·¦ä¸Šè§’</option>
                            </select>
                            <input type="range" id="wm-opacity" min="0" max="1" step="0.1" value="0.8" style="margin-top: 10px;">
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="processWatermark()">åº”ç”¨æ°´å°</button>
                <button class="btn btn-secondary" onclick="downloadCanvas('wm-canvas', 'watermarked.png')">ä¿å­˜</button>
                <div class="preview-area" style="margin-top: 20px;">
                    <canvas id="wm-canvas"></canvas>
                </div>
            </div>
        </div>

         <div id="crop" class="tool-container">
            <div class="card">
                <h2>å›¾ç‰‡è£å‰ª (è‡ªç”±é€‰åŒº)</h2>
                <div class="control-group">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 14px; background: rgba(37, 99, 235, 0.1); padding: 10px; border-radius: 6px;">
                        <strong>æ“ä½œæŒ‡å—ï¼š</strong><br>
                        1. ğŸ–±ï¸ <strong>é¼ æ ‡å·¦é”®æ‹–æ‹½</strong>ï¼šåœ¨ä¸‹æ–¹å›¾ç‰‡ä¸Šç»˜åˆ¶è£å‰ªåŒºåŸŸ<br>
                        2. âŒ¨ï¸ <strong>Enter é”®</strong> æˆ– ğŸ–±ï¸ <strong>é¼ æ ‡å³é”®</strong>ï¼šç¡®è®¤è£å‰ª<br>
                        3. ğŸ–±ï¸ <strong>åŒå‡»ç”»å¸ƒ</strong>ï¼šé‡ç½®/å–æ¶ˆé€‰æ‹©
                    </p>
                    <div class="upload-area">
                        <span>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                        <input type="file" id="crop-input" accept="image/*">
                    </div>
                </div>

                <div class="control-group">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="confirmCrop()">æ‰§è¡Œè£å‰ª (Enter)</button>
                        <button class="btn btn-secondary" onclick="resetCrop()">é‡ç½®åŸå›¾</button>
                        <button class="btn btn-secondary" onclick="downloadCanvas('crop-canvas', 'cropped.png')">ä¿å­˜ç»“æœ</button>
                    </div>
                </div>

                <div class="preview-area" style="background: #2c2c2c; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 400px; overflow: hidden;">
                    <canvas id="crop-canvas" style="cursor: crosshair; box-shadow: 0 0 20px rgba(0,0,0,0.5);"></canvas>
                </div>
            </div>
        </div>

        <div id="convert" class="tool-container">
            <div class="card">
                <h2>æ ¼å¼è½¬æ¢å·¥å…·</h2>
                <div class="upload-area">
                    <span>é€‰æ‹©å›¾ç‰‡ (æ”¯æŒæ‰¹é‡)</span>
                    <input type="file" id="convert-input" multiple accept="image/*">
                </div>
                <div class="control-group">
                    <label>ç›®æ ‡æ ¼å¼</label>
                    <select id="convert-format">
                        <option value="image/jpeg">JPG (JPEG)</option>
                        <option value="image/png">PNG</option>
                        <option value="image/webp">WEBP</option>
                    </select>
                </div>
                <button class="btn" onclick="processConvert()">è½¬æ¢å¹¶ä¸‹è½½</button>
                <div id="convert-log" style="margin-top: 1rem; color: var(--text-secondary);"></div>
            </div>
        </div>

        <div id="article" class="tool-container">
            <div class="card">
                <h2>æ–‡ç« å†…å®¹è¾…åŠ©</h2>
                <div class="control-group">
                    <label>å­—æ•°ç»Ÿè®¡ & é“¾æ¥æ£€æŸ¥ (ç²˜è´´å†…å®¹)</label>
                    <textarea id="article-content" rows="10" placeholder="åœ¨æ­¤ç²˜è´´æ–‡ç« å†…å®¹..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="analyzeArticle()">å¼€å§‹åˆ†æ</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('article-content').value=''">æ¸…ç©º</button>
                </div>
                <div style="margin-top: 20px; padding: 1rem; background: var(--bg-color); border-radius: 0.5rem;" id="article-stats">
                    ç­‰å¾…åˆ†æ...
                </div>
            </div>
        </div>

        <div id="settings" class="tool-container">
            <div class="card">
                <h2>è®¾ç½®</h2>
                <div class="control-group">
                    <label>ä¸»é¢˜åå¥½</label>
                    <select onchange="alert('Webç‰ˆé€šè¿‡ç³»ç»Ÿåå¥½è‡ªåŠ¨åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼')">
                        <option>è·Ÿéšç³»ç»Ÿ</option>
                        <option>æµ…è‰²</option>
                        <option>æ·±è‰²</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ç‰ˆæœ¬ä¿¡æ¯</label>
                    <p style="color: var(--text-secondary);">WeixinMPTools Web v1.3</p>
                    <p style="color: var(--text-secondary);">Core Logic ported from Python to JS</p>
                </div>
            </div>
        </div>

    </main>

    <div class="status-bar">
        <span id="status-text">å°±ç»ª</span>
        <span>Made with â¤ï¸ by AI</span>
    </div>

    <div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>

    <script>
        // ================= å…¨å±€å˜é‡ä¸å·¥å…·å‡½æ•° =================
        const state = {
            stitch: { topImg: null, bottomImg: null },
            watermark: { baseImg: null, wmImg: null },
            crop: { 
                originalImg: null, // ä¿å­˜åŸå§‹åŠ è½½çš„å›¾ç‰‡
                displayImg: null,  // å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡
                isDragging: false,
                startX: 0,
                startY: 0,
                rect: { x: 0, y: 0, w: 0, h: 0 },
                scale: 1 
            }
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
            updateStatus(msg);
        }

        function updateStatus(msg) {
            document.getElementById('status-text').innerText = msg;
        }

        function switchTab(tabId) {
            // UIåˆ‡æ¢
            document.querySelectorAll('.tool-container').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            updateStatus(`å·²åˆ‡æ¢åˆ°: ${tabId}`);
        }

        function downloadCanvas(canvasId, filename) {
            const canvas = document.getElementById(canvasId);
            if(canvas.width === 0) return showToast("ç”»å¸ƒä¸ºç©ºï¼Œæ— æ³•ä¸‹è½½");
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL();
            link.click();
            showToast("ä¸‹è½½å·²å¼€å§‹");
        }

        // é€šç”¨å›¾ç‰‡åŠ è½½å™¨
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ================= 1. å›¾ç‰‡æ‹¼æ¥é€»è¾‘ =================
        document.getElementById('stitch-top-input').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                state.stitch.topImg = await loadImage(e.target.files[0]);
                document.getElementById('top-area').style.border = "2px solid var(--success)";
                showToast("ä¸Šæ–¹å›¾å·²åŠ è½½");
            }
        });

        document.getElementById('stitch-bottom-input').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                state.stitch.bottomImg = await loadImage(e.target.files[0]);
                document.getElementById('bottom-area').style.border = "2px solid var(--success)";
                showToast("ä¸‹æ–¹å›¾å·²åŠ è½½");
            }
        });

        document.getElementById('stitch-spacing').addEventListener('input', (e) => {
            document.getElementById('spacing-val').innerText = e.target.value + 'px';
        });

        function processStitch() {
            if(!state.stitch.topImg || !state.stitch.bottomImg) return showToast("è¯·å…ˆé€‰æ‹©ä¸¤å¼ å›¾ç‰‡");
            
            const canvas = document.getElementById('stitch-canvas');
            const ctx = canvas.getContext('2d');
            const spacing = parseInt(document.getElementById('stitch-spacing').value);
            const bgColor = document.getElementById('stitch-bg').value;
            const widthMode = document.querySelector('input[name="stitch-width"]:checked').value;

            const img1 = state.stitch.topImg;
            const img2 = state.stitch.bottomImg;

            let targetWidth = widthMode === 'max' ? Math.max(img1.width, img2.width) : Math.min(img1.width, img2.width);

            const h1 = (targetWidth / img1.width) * img1.height;
            const h2 = (targetWidth / img2.width) * img2.height;

            canvas.width = targetWidth;
            canvas.height = h1 + h2 + spacing;

            if(bgColor !== 'transparent') {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            ctx.drawImage(img1, 0, 0, targetWidth, h1);
            ctx.drawImage(img2, 0, h1 + spacing, targetWidth, h2);

            showToast("æ‹¼æ¥å®Œæˆ");
        }

        // ================= 2. å°é¢æå– (Mock) =================
        function mockExtract() {
            const url = document.getElementById('extract-url').value;
            if(!url) return showToast("è¯·è¾“å…¥é“¾æ¥");
            
            showToast("æ­£åœ¨è¯·æ±‚...");
            setTimeout(() => {
                const img = document.getElementById('extract-img');
                img.src = "https://picsum.photos/600/300"; 
                img.style.display = "block";
                document.getElementById('extract-msg').innerHTML = "æå–æˆåŠŸ (æ¼”ç¤ºæ¨¡å¼)<br>å®é™…å›¾ç‰‡åœ°å€å·²è§£æï¼Œå› CORSä½¿ç”¨éšæœºå›¾å±•ç¤º";
                showToast("æå–å®Œæˆ");
            }, 1000);
        }

        // ================= 3. å›¾ç‰‡å‹ç¼© =================
        async function processCompress() {
            const files = document.getElementById('compress-input').files;
            if(files.length === 0) return showToast("æœªé€‰æ‹©å›¾ç‰‡");

            const quality = parseInt(document.getElementById('compress-quality').value) / 100;
            const container = document.getElementById('compress-results');
            container.innerHTML = '';

            for(let file of files) {
                const img = await loadImage(file);
                const cvs = document.createElement('canvas');
                cvs.width = img.width;
                cvs.height = img.height;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const dataUrl = cvs.toDataURL('image/jpeg', quality);
                
                const div = document.createElement('div');
                div.className = 'card';
                div.style.padding = '10px';
                div.innerHTML = `
                    <img src="${dataUrl}" style="width:100%; height:150px; object-fit:contain;">
                    <p style="font-size:12px; margin-top:5px;">åŸ: ${(file.size/1024).toFixed(1)}KB</p>
                    <a href="${dataUrl}" download="comp_${file.name.split('.')[0]}.jpg" class="btn" style="width:100%; margin-top:5px; font-size:12px;">ä¸‹è½½</a>
                `;
                container.appendChild(div);
            }
            showToast(`æ‰¹é‡å‹ç¼©å®Œæˆ: ${files.length}å¼ `);
        }

        // ================= 4. æ°´å° =================
        document.getElementById('wm-base-input').addEventListener('change', async (e) => {
            if(e.target.files[0]) state.watermark.baseImg = await loadImage(e.target.files[0]);
        });
        document.getElementById('wm-watermark-input').addEventListener('change', async (e) => {
            if(e.target.files[0]) state.watermark.wmImg = await loadImage(e.target.files[0]);
        });

        function toggleWmInput() {
            const type = document.getElementById('wm-type').value;
            document.getElementById('wm-text-controls').style.display = type === 'text' ? 'block' : 'none';
            document.getElementById('wm-image-controls').style.display = type === 'image' ? 'block' : 'none';
        }

        function processWatermark() {
            if(!state.watermark.baseImg) return showToast("è¯·å…ˆé€‰æ‹©åº•å›¾");
            
            const canvas = document.getElementById('wm-canvas');
            const ctx = canvas.getContext('2d');
            const img = state.watermark.baseImg;
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const type = document.getElementById('wm-type').value;
            const pos = document.getElementById('wm-position').value;
            const opacity = parseFloat(document.getElementById('wm-opacity').value);
            
            ctx.globalAlpha = opacity;

            let x = 0, y = 0;
            const padding = 40;

            if(type === 'text') {
                const text = document.getElementById('wm-text').value;
                const color = document.getElementById('wm-color').value;
                const size = document.getElementById('wm-size').value;
                
                ctx.font = `bold ${size}px Arial`;
                ctx.fillStyle = color;
                const textMetrics = ctx.measureText(text);
                
                if(pos.includes('right')) x = canvas.width - textMetrics.width - padding;
                else if(pos.includes('center')) x = (canvas.width - textMetrics.width) / 2;
                else x = padding;

                if(pos.includes('bottom')) y = canvas.height - padding;
                else if(pos.includes('center')) y = canvas.height / 2;
                else y = parseInt(size) + padding;

                ctx.fillText(text, x, y);

            } else if(type === 'image' && state.watermark.wmImg) {
                const wm = state.watermark.wmImg;
                const scale = (canvas.width * 0.2) / wm.width;
                const w = wm.width * scale;
                const h = wm.height * scale;

                if(pos.includes('right')) x = canvas.width - w - padding;
                else if(pos.includes('center')) x = (canvas.width - w) / 2;
                else x = padding;

                if(pos.includes('bottom')) y = canvas.height - h - padding;
                else if(pos.includes('center')) y = (canvas.height - h) / 2;
                else y = padding;

                ctx.drawImage(wm, x, y, w, h);
            }
            ctx.globalAlpha = 1.0;
            showToast("æ°´å°å·²åº”ç”¨");
        }

        // ================= 5. è£å‰ª (ä»¿PSè‡ªç”±é€‰åŒºç‰ˆ) =================
        const cropCanvas = document.getElementById('crop-canvas');
        const cropCtx = cropCanvas.getContext('2d');

        // åŠ è½½å›¾ç‰‡
        document.getElementById('crop-input').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                const img = await loadImage(e.target.files[0]);
                state.crop.originalImg = img;
                state.crop.displayImg = img;
                state.crop.rect = { x: 0, y: 0, w: 0, h: 0 };
                renderCropUI();
                showToast("å›¾ç‰‡å·²åŠ è½½ï¼Œè¯·æ‹–æ‹½ç»˜åˆ¶é€‰åŒº");
            }
        });

        // æ ¸å¿ƒæ¸²æŸ“ï¼šå›¾ç‰‡ + é®ç½© + é€‰åŒº
        function renderCropUI() {
            if (!state.crop.displayImg) return;
            const img = state.crop.displayImg;

            const maxWidth = 800;
            const maxHeight = 500;
            let displayW = img.width;
            let displayH = img.height;

            if (displayW > maxWidth || displayH > maxHeight) {
                const ratio = Math.min(maxWidth / displayW, maxHeight / displayH);
                displayW = displayW * ratio;
                displayH = displayH * ratio;
            }

            cropCanvas.width = displayW;
            cropCanvas.height = displayH;
            
            state.crop.scale = img.width / displayW;

            cropCtx.drawImage(img, 0, 0, displayW, displayH);

            // ç»˜åˆ¶é®ç½©å’Œé€‰åŒº
            if (state.crop.rect.w > 0 && state.crop.rect.h > 0) {
                // é»‘è‰²é®ç½©
                cropCtx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                cropCtx.fillRect(0, 0, displayW, displayH);

                const { x, y, w, h } = state.crop.rect;
                const s = state.crop.scale;
                
                // ç»˜åˆ¶é€‰åŒºè¾¹æ¡†
                cropCtx.strokeStyle = '#fff';
                cropCtx.lineWidth = 2;
                cropCtx.setLineDash([5, 3]);
                cropCtx.strokeRect(x, y, w, h);
                
                // æ¸…é™¤é€‰åŒºå†…çš„é®ç½©ï¼ˆé€šè¿‡clipé‡æ–°ç»˜åˆ¶åŸå›¾ï¼‰
                cropCtx.save();
                cropCtx.beginPath();
                cropCtx.rect(x, y, w, h);
                cropCtx.clip();
                cropCtx.drawImage(img, 0, 0, displayW, displayH);
                cropCtx.restore();

                // å°ºå¯¸æç¤º
                cropCtx.fillStyle = '#fff';
                cropCtx.font = '12px Arial';
                cropCtx.setLineDash([]);
                cropCtx.fillText(`${Math.round(w * s)} x ${Math.round(h * s)}`, x + 5, y - 8);
            }
        }

        // é¼ æ ‡äº¤äº’
        cropCanvas.addEventListener('mousedown', (e) => {
            if (!state.crop.displayImg) return;
            state.crop.isDragging = true;
            const rect = cropCanvas.getBoundingClientRect();
            state.crop.startX = e.clientX - rect.left;
            state.crop.startY = e.clientY - rect.top;
            state.crop.rect = { x: state.crop.startX, y: state.crop.startY, w: 0, h: 0 };
        });

        window.addEventListener('mousemove', (e) => {
            if (!state.crop.isDragging) return;
            const rect = cropCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            let w = currentX - state.crop.startX;
            let h = currentY - state.crop.startY;
            let x = state.crop.startX;
            let y = state.crop.startY;

            if (w < 0) { x = currentX; w = Math.abs(w); }
            if (h < 0) { y = currentY; h = Math.abs(h); }

            if (x < 0) x = 0;
            if (y < 0) y = 0;
            if (x + w > cropCanvas.width) w = cropCanvas.width - x;
            if (y + h > cropCanvas.height) h = cropCanvas.height - y;

            state.crop.rect = { x, y, w, h };
            renderCropUI();
        });

        window.addEventListener('mouseup', () => {
            state.crop.isDragging = false;
        });

        cropCanvas.addEventListener('dblclick', () => {
            state.crop.rect = { x: 0, y: 0, w: 0, h: 0 };
            renderCropUI();
        });

        // å³é”®å’ŒEnterç¡®è®¤
        cropCanvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            confirmCrop();
            return false;
        });

        window.addEventListener('keydown', (e) => {
            const cropTab = document.getElementById('crop');
            if (cropTab.classList.contains('active') && e.key === 'Enter') {
                confirmCrop();
            }
        });

        function confirmCrop() {
            if (!state.crop.displayImg) return;
            const { x, y, w, h } = state.crop.rect;

            if (w < 5 || h < 5) return showToast("è¯·å…ˆæ‹–æ‹½é€‰æ‹©è£å‰ªåŒºåŸŸ");

            const scale = state.crop.scale;
            const realX = x * scale;
            const realY = y * scale;
            const realW = w * scale;
            const realH = h * scale;

            const tempCvs = document.createElement('canvas');
            tempCvs.width = realW;
            tempCvs.height = realH;
            const tempCtx = tempCvs.getContext('2d');

            tempCtx.drawImage(state.crop.displayImg, realX, realY, realW, realH, 0, 0, realW, realH);

            const newImg = new Image();
            newImg.src = tempCvs.toDataURL();
            newImg.onload = () => {
                state.crop.displayImg = newImg;
                state.crop.rect = { x: 0, y: 0, w: 0, h: 0 };
                renderCropUI();
                showToast("è£å‰ªæˆåŠŸï¼(å³é”®å¯ç»§ç»­è£å‰ª)");
            };
        }

        function resetCrop() {
            if (state.crop.originalImg) {
                state.crop.displayImg = state.crop.originalImg;
                state.crop.rect = { x: 0, y: 0, w: 0, h: 0 };
                renderCropUI();
                showToast("å·²é‡ç½®ä¸ºåŸå›¾");
            }
        }

        // ================= 6. è½¬æ¢ =================
        async function processConvert() {
            const files = document.getElementById('convert-input').files;
            if(files.length === 0) return showToast("æœªé€‰æ‹©æ–‡ä»¶");
            const format = document.getElementById('convert-format').value;
            const ext = format.split('/')[1];

            for(let file of files) {
                const img = await loadImage(file);
                const cvs = document.createElement('canvas');
                cvs.width = img.width;
                cvs.height = img.height;
                cvs.getContext('2d').drawImage(img, 0, 0);
                
                const link = document.createElement('a');
                link.download = `converted_${file.name.split('.')[0]}.${ext}`;
                link.href = cvs.toDataURL(format, 0.9);
                link.click();
            }
            showToast("è½¬æ¢å¹¶ä¸‹è½½å·²å¯åŠ¨");
        }

        // ================= 7. æ–‡ç« åˆ†æ =================
        function analyzeArticle() {
            const text = document.getElementById('article-content').value;
            if(!text) return showToast("å†…å®¹ä¸ºç©º");

            const chars = text.length;
            const noSpace = text.replace(/\s/g, '').length;
            const paragraphs = text.split(/\n\s*\n/).filter(Boolean).length;
            const readTime = Math.ceil(noSpace / 400); 
            
            const links = text.match(/https?:\/\/[^\s]+/g) || [];

            document.getElementById('article-stats').innerHTML = `
                <p><strong>æ€»å­—ç¬¦æ•°:</strong> ${chars}</p>
                <p><strong>æœ‰æ•ˆå­—ç¬¦(å»ç©º):</strong> ${noSpace}</p>
                <p><strong>æ®µè½æ•°:</strong> ${paragraphs}</p>
                <p><strong>é¢„è®¡é˜…è¯»æ—¶é—´:</strong> ${readTime} åˆ†é’Ÿ</p>
                <hr style="margin: 10px 0; border: 0; border-top: 1px solid var(--border);">
                <p><strong>å‘ç°é“¾æ¥:</strong> ${links.length} ä¸ª</p>
                <div style="max-height: 100px; overflow-y: auto; font-size: 12px; color: var(--text-secondary);">
                    ${links.map(l => `<div>${l}</div>`).join('')}
                </div>
            `;
            showToast("åˆ†æå®Œæˆ");
        }

    </script>
</body>
</html>
